<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat app.</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
</head>
<body>
    <div class="container" style="background-color: #7CB9E8;">
        <h1>Chat app.</h1>
        <h3 id="chat-header">Currently in chat : General</h3>

        <form action="" id="chatroom-selection">
            <label for="chatroom">Chatroom</label>
            <input type="text" cname="chatroom" id="chatroom">
            <input type="submit" value="Change chatroom" class="btn btn-success">
        </form>

        <span>Chats </span> <br>
        <textarea name="chatmessages" id="chatmessages" class="form-control" cols="50" rows="5" readonly  class="messagearea" placeholder="Welcome to the general chatroom, here messages from others will appear"></textarea> 
        
        <br>
        <form action="" id="chat-message">
            <label for="message">Message :</label> <br>
            <!-- <div class="d-flex"> -->
                <input type="text" name="message" id="message"  class="form-control">
                <!-- <textarea  name="message" id="message" rows="1" class="form-control" style="width: 80%;"></textarea> -->
                <input type="submit" value="Send message" class="btn btn-success" >
            <!-- </div> -->
        </form>
        <div>
            <form action="" id="login-form">
                <label for=""></label>
                <input type="text" name="username" id="username" class="form-control">
                <label for=""></label><input type="password" name="password" id="password" class="form-control"><input type="submit" value=""></form></div>
    </div>

    <script>
        const $ = document.querySelector.bind(document);
        var selected_chat = "general"; 
        
        class Event {
            constructor(type, payload) {
                this.type = type;
                this.payload  = payload;  
            }
        }
        
        function routeEvent(event) {
            if(event.type === undefined) {
                alert("no 'type' field in event")
            }
            switch (event.type ) {
                case "new_message": {
                    console.log(new message);
                    break;
                } 
                default : {
                    alert("unsupported message type");
                    break;
                }
            }

        }

        function changeChatroom() {
            var newchat = $("#chatroom");
            if(newchat != null && newchat.value != selected_chat) {
                console.log(newchat);
            }
            return false;
        }

        function sendMessage() {
            var newmessage = $("#message");
            if(newmessage != null ) {
                send_message("new_message", newmessage.value);
                console.log(newmessage.value)
            }
            return false;
        }

        function send_message(eventName, payload) {
            const event = new Event(eventName, payload)

            conn.send(JSON.stringify(event))
        }

        window.onload = function () {
            $("#chatroom-selection").onsubmit = changeChatroom;
            $("#chat-message").onsubmit = sendMessage;

            if(window["WebSocket"]) {
                console.log("supports websocket");
                conn = new WebSocket("ws://"+ document.location.host + "/ws");

                conn.onmessage = function (evt) {
                    console.log(evt);
                    const eventData = JSON.parse(evt.data);
                    const event = Object.assign(new Event, eventData);

                    routeEvent(event);

                }
            } else {
                alert("Websocket not selected by the brpwser")
            }
        }
    </script>
    
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
</body>
</html>